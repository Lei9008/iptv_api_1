name: Update IPTV Sourcesï¼ˆæ›´æ–°IPTVæºï¼‰

on:
  schedule:
    # æ¯3å¤©UTCæ—¶é—´16:55æ‰§è¡Œï¼ˆå¯¹åº”ä¸Šæµ·æ—¶é—´00:55ï¼‰
    - cron: '55 16 */3 * *'  
  workflow_dispatch:  # å…è®¸æ‰‹åŠ¨è§¦å‘
    inputs:
      force_update:
        description: 'å¼ºåˆ¶æ›´æ–°ï¼ˆå³ä½¿æ— æ–‡ä»¶å˜æ›´ï¼‰'
        required: false
        default: 'false'
        type: boolean

env:
  TZ: Asia/Shanghai  # è®¾ç½®æ—¶åŒºä¸ºä¸Šæµ·
  PYTHONUNBUFFERED: "1"  # ç¦ç”¨Pythonè¾“å‡ºç¼“å†²ï¼Œå®æ—¶æ‰“å°æ—¥å¿—

jobs:
  update-iptv-sources:
    runs-on: ubuntu-latest
    timeout-minutes: 120  # è®¾ç½®ä»»åŠ¡è¶…æ—¶æ—¶é—´ï¼ˆé¿å…æ— é™è¿è¡Œï¼‰
    permissions:
      contents: write  # æˆäºˆæäº¤ä»£ç çš„æƒé™
      actions: write   # æˆäºˆç®¡ç†workflowçš„æƒé™ï¼ˆå¯é€‰ï¼Œç”¨äºæ¸…ç†æ—§è¿è¡Œè®°å½•ï¼‰

    steps:
      - name: æ£€å‡ºä»£ç åº“
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # æ‹‰å–å®Œæ•´å†å²ï¼Œé¿å…rebaseå†²çª
          ref: main       # æ˜ç¡®æŒ‡å®šä¸»åˆ†æ”¯

      - name: ç³»ç»Ÿç¯å¢ƒå‡†å¤‡
        run: |
          # æ›´æ–°ç³»ç»Ÿå¹¶å®‰è£…ä¾èµ–
          sudo apt-get update -y
          sudo apt-get install -y --no-install-recommends ffmpeg curl wget
          sudo apt-get clean
          # æ£€æŸ¥ç£ç›˜ç©ºé—´ï¼ˆé¿å…ç©ºé—´ä¸è¶³ï¼‰
          df -h
          # æ£€æŸ¥ç½‘ç»œè¿é€šæ€§
          curl -I https://raw.githubusercontent.com -m 10

      - name: è®¾ç½®Pythonç¯å¢ƒ
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'
          cache: 'pip'  # è‡ªåŠ¨ç¼“å­˜pipä¾èµ–
          cache-dependency-path: |
            **/requirements.txt
            *.txt

      - name: å®‰è£…Pythonä¾èµ–
        run: |
          # å‡çº§pipå¹¶å®‰è£…ä¾èµ–
          python -m pip install --upgrade pip setuptools wheel
          pip install requests>=2.31.0 aiohttp>=3.9.0 python-dotenv
          # æ‰“å°ä¾èµ–ç‰ˆæœ¬ï¼Œä¾¿äºè°ƒè¯•
          pip list
          # éªŒè¯ä¾èµ–å®‰è£…
          python -c "import requests, aiohttp; print('ä¾èµ–å®‰è£…æˆåŠŸ')"

      - name: æ‰§è¡ŒIPTVè„šæœ¬
        id: run_script
        continue-on-error: false  # è„šæœ¬æ‰§è¡Œå¤±è´¥åˆ™ç»ˆæ­¢ä»»åŠ¡
        run: |
          # æ‰“å°ç³»ç»Ÿä¿¡æ¯
          echo "========== ç³»ç»Ÿä¿¡æ¯ =========="
          echo "Pythonç‰ˆæœ¬: $(python --version)"
          echo "å·¥ä½œç›®å½•: $(pwd)"
          echo "å½“å‰æ—¶é—´: $(date '+%Y-%m-%d %H:%M:%S %Z')"
          echo "ç£ç›˜ç©ºé—´: $(df -h . | awk 'NR==2 {print $4}') å¯ç”¨"
          echo "========== æ‰§è¡Œè„šæœ¬ =========="
          # æ‰§è¡Œä¸»è„šæœ¬å¹¶ä¿å­˜è¯¦ç»†æ—¥å¿—
          python main.py 2>&1 | tee iptv_run.log
          # æ£€æŸ¥è„šæœ¬æ‰§è¡Œç»“æœ
          if [ ${PIPESTATUS[0]} -ne 0 ]; then
            echo "è„šæœ¬æ‰§è¡Œå¤±è´¥ï¼"
            cat iptv_run.log
            exit 1
          fi
          echo "script_exit_code=0" >> $GITHUB_OUTPUT

      - name: æ£€æŸ¥æ–‡ä»¶å˜æ›´
        id: check_changes
        run: |
          # æ£€æŸ¥è¾“å‡ºç›®å½•æ˜¯å¦å­˜åœ¨
          if [ -d "output" ]; then
            echo "è¾“å‡ºç›®å½•å­˜åœ¨ï¼Œæ–‡ä»¶åˆ—è¡¨ï¼š"
            ls -l output/
          fi
          # æ£€æŸ¥æ˜¯å¦æœ‰æ–‡ä»¶å˜æ›´
          if git diff --quiet; then
            echo "changed=false" >> $GITHUB_OUTPUT
            echo "âœ… æ— æ–‡ä»¶å˜æ›´"
            # å¼ºåˆ¶æ›´æ–°é€»è¾‘
            if [ "${{ github.event.inputs.force_update }}" = "true" ]; then
              echo "âš ï¸ æ£€æµ‹åˆ°å¼ºåˆ¶æ›´æ–°æ ‡è®°ï¼Œå°†åˆ›å»ºç©ºæäº¤"
              echo "changed=true" >> $GITHUB_OUTPUT
            fi
          else
            echo "changed=true" >> $GITHUB_OUTPUT
            echo "ğŸ”„ æ£€æµ‹åˆ°æ–‡ä»¶å˜æ›´ï¼Œå˜æ›´åˆ—è¡¨ï¼š"
            git status --short
            # æ˜¾ç¤ºå˜æ›´å†…å®¹æ‘˜è¦
            git diff --stat
          fi

      - name: æäº¤å¹¶æ¨é€å˜æ›´
        if: steps.check_changes.outputs.changed == 'true'
        run: |
          # é…ç½®Gitç”¨æˆ·ä¿¡æ¯
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "GitHub Actions Bot"
          git config --local pull.rebase true  # é»˜è®¤ä½¿ç”¨rebase

          # æ·»åŠ æ‰€æœ‰å˜æ›´æ–‡ä»¶
          git add -A

          # æ„å»ºæäº¤ä¿¡æ¯
          if [ "${{ github.event.inputs.force_update }}" = "true" ]; then
            commit_msg="Force update IPTV sources: $(date '+%Y-%m-%d %H:%M:%S')"
          else
            commit_msg="Auto-update IPTV sources: $(date '+%Y-%m-%d %H:%M:%S')"
          fi

          # æäº¤å˜æ›´
          git commit -m "$commit_msg"

          # å®‰å…¨æ¨é€ï¼ˆè§£å†³å†²çªï¼‰
          echo "ğŸ”„ æ¨é€å˜æ›´åˆ°è¿œç¨‹ä»“åº“..."
          git pull origin main --rebase || (git rebase --abort && git pull origin main)
          git push origin main --force-with-lease  # å®‰å…¨å¼ºåˆ¶æ¨é€

          echo "âœ… å˜æ›´å·²æˆåŠŸæ¨é€ï¼"

      - name: ä¸Šä¼ æ‰§è¡Œæ—¥å¿—
        if: always()  # æ— è®ºä»»åŠ¡æˆåŠŸ/å¤±è´¥éƒ½ä¸Šä¼ æ—¥å¿—
        uses: actions/upload-artifact@v4
        with:
          name: iptv-execution-log-${{ github.run_id }}
          path: |
            iptv_run.log
            output/*.log
            function.log
          retention-days: 7  # æ—¥å¿—ä¿ç•™7å¤©

      - name: æ¸…ç†æ—§çš„Workflowè¿è¡Œè®°å½•ï¼ˆå¯é€‰ï¼‰
        if: always()
        uses: Mattraks/delete-workflow-runs@v2
        with:
          token: ${{ github.token }}
          repository: ${{ github.repository }}
          keep_minimum_runs: 3  # ä¿ç•™æœ€è¿‘5æ¡è¿è¡Œè®°å½•
          retain_days: 0        # ä¿ç•™7å¤©å†…çš„è¿è¡Œè®°å½•
          ignore_error: true    # å¿½ç•¥æ¸…ç†é”™è¯¯

      - name: ä»»åŠ¡å¤±è´¥é€šçŸ¥ï¼ˆå¯é€‰ï¼‰
        if: failure()
        run: |
          echo "âŒ IPTVæºæ›´æ–°ä»»åŠ¡æ‰§è¡Œå¤±è´¥ï¼"
          # å¯æ·»åŠ é’‰é’‰/ä¼ä¸šå¾®ä¿¡/é‚®ä»¶é€šçŸ¥é€»è¾‘
          # ç¤ºä¾‹ï¼šé’‰é’‰æœºå™¨äººé€šçŸ¥
          # curl -H "Content-Type: application/json" -X POST -d '{"msgtype":"text","text":{"content":"IPTVæºæ›´æ–°å¤±è´¥ï¼š${{ github.run_url }}"}}' https://oapi.dingtalk.com/robot/send?access_token=ä½ çš„token
